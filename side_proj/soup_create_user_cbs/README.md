# CBS Multi-Thread Load Test

Инструмент для многопоточного тестирования CBS системы с созданием тестовых пользователей.

## Логика работы

**Независимые потоки:** Каждый поток работает в своем ритме, не ожидая других потоков.

```
Поток 1: атака → ответ(3с) → пауза(5с) → атака → ответ(1с) → пауза(5с) → атака...
Поток 2: атака → ответ(7с) → пауза(5с) → атака → ответ(2с) → пауза(5с) → атака...
Поток 3: атака → ответ(1с) → пауза(5с) → атака → ответ(4с) → пауза(5с) → атака...
```

Быстрые потоки НЕ ждут медленные - каждый идет в своем темпе!

## Файлы

- `single_user_test.py` - Тест одного пользователя для проверки соединения
- `multi_thread_test.py` - Полный многопоточный нагрузочный тест  
- `config.json` - Конфигурация тестов
- `new.xml` - SOAP шаблон для запросов

## Установка

### 1. Требования
- Python 3.7+
- Доступ к CBS серверу

### 2. Установка зависимостей

```bash
# Установка зависимостей
pip install -r requirements.txt
```

### 3. Подготовка файлов

Убедитесь, что в папке с проектом есть:
- `new.xml` - XML шаблон для SOAP запросов
- `config.json` - конфигурационный файл

## Настройка

### Конфигурация в config.json

```json
{
    "cbs_settings": {
        "endpoint": "http://localhost:7201/FCUBSCustomerService/FCUBSCustomerService",
        "soap_action": "CreateCustomer",
        "timeout": 30
    },
         "test_parameters": {
         "thread_count": 5,
         "attacks_per_test": 5,
         "delay_between_requests": 5
     }
}
```

### Параметры настройки:

**CBS Settings:**
- `endpoint` - URL CBS сервиса
- `soap_action` - SOAP Action заголовок
- `timeout` - таймаут запроса в секундах

**Test Parameters:**
- `thread_count` - количество потоков (по умолчанию 5)
- `attacks_per_test` - количество атак, которые делает каждый поток (по умолчанию 5)
- `delay_between_requests` - пауза между атаками внутри каждого потока в секундах

**Всего запросов:** `thread_count × attacks_per_test` (5 × 5 = 25 запросов)

## Запуск

### Тест одного пользователя (рекомендуется для начала):
```bash
python single_user_test.py
```

Пример вывода:
```
ТЕСТ ОДНОГО ПОЛЬЗОВАТЕЛЯ CBS
==================================================
Пользователь: Иванов Иван
ИНН: 215031985123456
Паспорт: ID8000123456  
Телефон: 996701234567
Email: ivan.ivanov@test.multi
Message ID: TEST123456789
Endpoint: http://localhost:7201/FCUBSCustomerService/FCUBSCustomerService
--------------------------------------------------
Отправляем запрос...
Время ответа: 1.234 секунд
HTTP статус: 200
--------------------------------------------------
✅ УСПЕХ!
Номер клиента: 0000123456

Полный результат сохранен в: single_user_test_20240101_143025.json
```

### Полный многопоточный тест:
```bash
python multi_thread_test.py
```

### Пример вывода в консоли:

```
НЕЗАВИСИМЫЙ ТЕСТ CBS
==================================================
Потоков: 5
Атак на поток: 5
Всего запросов: 25
Пауза между атаками в потоке: 5с
Endpoint: http://localhost:7201/FCUBSCustomerService/FCUBSCustomerService
==================================================
Каждый поток работает в своем ритме независимо!

Поток 1 запущен - будет делать 5 атак независимо
Поток 1, атака 1/5: Иванов Иван
  -> УСПЕХ! Клиент #123456 (1.25с)
  -> Поток 1 ждет 5с перед следующей атакой...
Поток 1, атака 2/5: Петров Петр
  -> УСПЕХ! Клиент #789012 (2.1с)

Поток 2 запущен - будет делать 5 атак независимо
Поток 2, атака 1/5: Сидоров Игорь
  -> ОШИБКА: ['E001: Duplicate INN'] (0.85с)

РЕЗУЛЬТАТЫ НЕЗАВИСИМОГО ТЕСТА:
==================================================
Общее время: 45.2с
Всего запросов: 25
Успешных: 20
Неуспешных: 5
Общий процент успеха: 80.0%

СТАТИСТИКА ПО ПОТОКАМ:
Поток 1: 5/5 успешно (100.0%)
Поток 2: 4/5 успешно (80.0%)
Поток 3: 3/5 успешно (60.0%)
```

## Результаты

### Тест одного пользователя:
Создается файл: `single_user_test_YYYYMMDD_HHMMSS.json`

### Многопоточный тест:
Создается файл: `multi_thread_test_results_YYYYMMDD_HHMMSS.json`

### Структура результатов:

```json
{
    "test_suite": "CBS Independent Thread Test",
    "test_type": "independent_threads",
    "timestamp": "20240101_120000",
    "overall_test_time": 250.5,
    "configuration": {...},
    "thread_statistics": {
        "0": {
            "total": 5,
            "successful": 5,
            "failed": 0,
            "success_rate": 100.0
        },
        "1": {
            "total": 5, 
            "successful": 4,
            "failed": 1,
            "success_rate": 80.0
        }
    },
    "summary": {
        "total_threads": 5,
        "attacks_per_thread": 5,
        "total_requests": 25,
        "total_successful": 23,
        "total_failed": 2,
        "overall_success_rate": 92.0,
        "avg_requests_per_second": 0.5
    },
    "all_results": [
        {
            "success": true,
            "customer_number": "123456",
            "response_time": 1.234,
            "thread_id": 0,
            "attack_num": 1,
            "full_response": "полный XML ответ от CBS",
            "user_data": {...}
        }
    ]
}
```

## XML Шаблон

Шаблон `new.xml` должен содержать плейсхолдеры:
- `{messageId}` - уникальный ID сообщения
- `{inn}` - ИНН пользователя
- `{first_name}`, `{last_name}`, `{patronymic}` - ФИО на русском
- `{first_name_en}`, `{last_name_en}`, `{patronymic_en}` - ФИО на английском
- `{passport_num}` - номер паспорта
- `{phone}` - номер телефона
- `{email}` - email адрес
- `{crm_ref}` - CRM референс
- `{passport_issue_date}`, `{passport_expiry_date}` - даты паспорта
- `{index}` - уникальный индекс

## Примечания

- Все данные пользователей генерируются автоматически
- ИНН формируется по правилам: пол + дата рождения + случайные цифры  
- Подробные логи выводятся в консоль во время выполнения
- В JSON сохраняются полные HTTP запросы и ответы для анализа
- **Независимые потоки:** каждый поток работает в своем ритме
- **Паузы только внутри потоков:** между атаками одного потока
- **Статистика по потокам:** видно производительность каждого потока
- При ошибках соединения тест продолжает выполнение 